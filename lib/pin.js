const { z } = require('zod');
const axios = require('axios');
const cheerio = require('cheerio');

const PinterestSchema = z.string().url();
const DEFAULT_HEADERS = {
    'accept': '*/*',
    'accept-encoding': 'gzip, deflate, br',
    'accept-language': 'en-US,en;q=0.9',
    'sec-ch-ua': '"Google Chrome";v="117", "Not;A=Brand";v="8", "Chromium";v="117"',
    'sec-ch-ua-mobile': '?0',
    'sec-fetch-dest': 'empty',
    'sec-fetch-mode': 'cors',
    'sec-fetch-site': 'same-origin',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36'
}

async function pinterest(query) {
  const data = await axios.get(`https://id.pinterest.com/search/pins/?autologin=true&q=${query}`, {
    headers: {
      ...DEFAULT_HEADERS,
      cookie: 'csrftoken=97c720102d3663c43f0030424cd5ae84; _routing_id="297fb058-766b-4b78-aeb4-ea7bc03b234b"; sessionFunnelEventLogged=1; _auth=1; _pinterest_sess=TWc9PSZqRU9jUXU0V1I1NndrU0hnSlhzWkh2c1Bsd1lhMTI3a3AzOTN2LzhJUi83RXo5WkREWWJ6Vy9jNTFNa3c4Uy8wR0RoSklmbWs2dHBrTEtGWkJzeTdJNXd5ZDQ0Mm04NGlCMnhYN0JXY3VMa3dMeWhGMjNqK1ZBMlZ2Z3VpR1dOUUdFcW9yeG82TFlpeHhGaWM4Tjk0MDVZbVp5S2ZXQXoveTB6VkRzU0tLNy9OMlZBU1k1U0VHTkNUei9DUW9UTlRpdm9YRGVDRGNXUEp5dDh4NjNFR2V5K3hXdHJJUGp3c05Ycitqd1FaSXI1c3k1T3BGSERzTXVWOFkxUnZpUjkxWXNDQytVK2EzNUJHaCtHRTlQUThkd01LMGJTU2FQNHhwVUJKOVpTT3QvZHgyaDd2YlRuaGZHcGtWeEtIRWlGNlBkbmIvUGtyUy8wUFlLaU5mT0wyOUlIT1RuNzdmNmNEQ21nWTJzRno1bUV2MkdPc2NvUmZNNUtwWUxwZ084QWRkdXdCeDJHS0k1dDJyTC8raDhQNGg3K1hUdVRuaGRyUjRRdXI1V3JMRStBZjE5MjZ2VzM0NEtQVUdTQkpUK2NwSTZkcm9VSDc4bGtqbFJ0TnZpQ2dnU2ltR1dmM1V5N0hRY2E1RWdLWVQzRTdQWExIaEdHSmFvMnV4YVF1NGhsTTZEdi9TREVrUDJwNFVBQWVjOXllVUY5a1lpcFRsYnY3cE1Md3JrZUJsa09zOGd1NG4yQTBybXJ1R2xMWE5jMVZPQjN1UGJsWDdtQUtIZ280c0pjQWgyZzFkTUNXWitxbHNrTTVWYmtmV3BZcllvVFcrMU9nUU51U2tiRVROS3NidFFzVGMwam1KVU5HVXVYeEdubUpQZDFJamxjU3hVOFBMUDdwVnJjc2VFa2xGZUNndFFNTEtrNkx5MURWd1lBTThSRFp4dGJ3U0w0S1JCVmtTUHQvL0cxa3pSUjdsVzRIeHdpd0VnRklBK3R4YjZ5WEJVbkFibnVZZ3ZMU0REZUZyM25WQytMMUt4aE9wQ2hwZ0dOeTUwNUpDeFpESzhzRkszbHBHbnk3dGZlQ1h0Q01KQ1NSMytwN3ZGQS83aWtsdVNET1dXMm5rUHEycEgwS2x1eEh4NnN1cmltc21vT2tpTTdSblpXTUY4bXlvZmlQSm9SZ3ltaStFRUNYeWRIQlExK1pIOHpZQVZkTkNDT1pCbnd1bHdqdldsWUV5QkM3WTZkYU1rNjhrZHBvRjJrN2x4K2xvRDdEbUVVeGIzUnMrUEhqbHJpRDVkeHJHT3IyNStwUENXNDZCTk5wT3VWUlVLbUxjTG13aEovZ2M2Z0p3b1hxcVRQckoxdTNmSkl6Y2tObDBYZE5LMG93ODdzVVNNa21KUUorTnZCaEYvcStnVHVmOGhoWmFsZG1aL0pqRjAzTzVCc0VnL1B6UGNtNUc5bGF0TkRkS2trU0hUeThacEZ2RnpTRFRFRHdMai9sSDF3Wlp5TkdaTzZLN1dCUTA4SFNYd2h2dlVBY1FpTzNmakxrVkwwNlVEZnY0MEQzclVhZmZ6Q2h4aERLc0RvUEkzQ0xrOUYvZW1FdmdEN3ppcTFmeXpsdWlwQVNEc3BBcW5iNmVjZ2xjSitQRk9vbjc2K3dVUisvWmVFNVFobDVUVHA5Rzk5NXhOcWIzVXpwUjIxNEQ0RUlRRUxLMHFmdUE2MXBoRVlIbHN0ckUzL24yTkVPMURRNjFGc3lEM2RZTU5ZTXlKZjJqMWtIS0NNd1ptdDFkVGFCaDNiRysxRHMmb2hCY0t5NlRLMVJWVHJHNmZOVzBZYmtzaU53PQ==; __Secure-s_a=aVpsdzZSaEthcjE5VHE1bFFYRndFLzUxKzh0dkNjbjJQaUJpY2R1T2RxRG9Rd1NkVTJUL20xMXlsMFlZYzZSRG8wRk4yODJzcFVJaVgzSVZrd0JaTTZmTnBXYWp6K2lXVGtkK0ovV09Gd1ErQXgvYmtYUmpJUjZ0M3lRYTd6dHNnMitGWXRlNVhneWkyRk5PWkVKRmdTYmFobnpPNEswbW42VEUrN1QxZkFzK2ZCdElvZDFYWnBKeVd5dVZCbllpV1RtNmdYZFcvdlA1WVNSelVWckxSTnBFMnF4VGFmV1BWQmo0WWI0NEJ1VXQyWTRUcU4rbDZNa0FGVHF2YkEycUdPSXFBVWtjczFITHBNQ3prRElCcitnM3ZNZlNKUThIcFJHRGNEcUNBd2lDYisrTE5XTlNUT3dCYVVsV2pkckNFR1ZFTE10UUQxaHdDMjQ5OEN2dHM4VnlvYW9mdGRuQkxlbW9xSUVUaDlDT0F1R3NSQ0JaaklJT1QrTFo4WjJJNVQ0Z0FScUN5bGZ5eWVNT0lLYXBGeVU1a3BGaEVvTUdhNWRBRjc0VDJxeDBMandhTVRXWEQ5N0p2azlQMmZPL2JnWnhDNTlzQkxYd0pmUFZvZWs5MWc1ZTljMXkrdTRyV1ovcEo4Rk5SK1FvQUtuT2xiY0M2bUpsM2FYcUEwM280WHo4T0JJTjhWL3B2TEY4c0ZVYVZjU1pPWGpCV1kyNkFqVjJ5Mytwcmp1bFhIOFBNem4wSmVnUkQwM2QwWmx5ODMzZ3RraEcvckt3M3Zud0tXTTBkMmRJRGZSVDlLZUc5WDJBL1lkV0czcEU3eFhlQkxWbVZWQ0hHZVZ2UXRJeGgxVGlDd29aSDV0NWhFTjdTZk5IY1VGQWNMSzY1b1lQRUt1WE1ZMU1pK0VUWDZWc3FsSTBhUEY2L1pLaGQ4dWZwNWhCVHNBYzZoUzVEa2FCZmtZNDJrOGlyUjFFOGt0Q21RQjJGUzI1N3hCUWlENEhZT1hCdktkU0FMVy9SSTdoa0VBWHhub2VNV1E3cXR5NWp6eUtxZExSeWFFYU5PVFE2KzY5c2tVV2I0Q0xkYk9KaHQvV1FGZVhLaVJaQTd0ai9FTHZTUkpSazRpRlhkb01zRjlTY3JBVmY0ZGsyd2VUMjNRY1RhTWJKRTZWSm5wYVI4dno3N05lbzNzWGJqM05TVnhZZE5IalJlcTJkNUJ2MmVKMjZjU0c3cnkrTCswbTRIQmRTUWxxSDJCa0V0eG55MVZtUGtNcFRiNE9DbkZsVVVUY2FlNWF6YWIvQjNicXZPZW1VMmRxaXRiQVVLdkVJdzJ1UEdrbXJRWT0mWk5ZTDN6c1RMNWREM3VsYzFjR2hqWDVmd2dVPQ==; _b="AY34Cuu2xzFEn6gCp51AvLOGLQG9J3APDb33EgAvTAgfpql128ItiVUtN1nPVtUC2/o="; ar_debug=1;'
    }
  }).data;

  const results = [];
  const $ = cheerio.load(data);

  $('img').each(function () {
    results.push($(this).attr('src'));
  });

  return results.map((value) => PinterestSchema.parse(value));
}

module.exports = pinterest;
